<!DOCTYPE html>
<html>
<head>
<title>Hungry Horace: Routine at 27044</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="Hungry Horace" src="../../images/logo-dec.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="27022.html">27022</a>
</td>
<td class="up">Up: <a href="../maps/all.html#27044">Map</a></td>
<td class="next">
Next: <a href="27159.html">27159</a>
</td>
</tr>
</table>
<div class="description">27044: Ring the bell if necessary</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
Called from the main loop at <a href="25129.html">25129</a>.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="27044"></span>27044</td>
<td class="instruction">LD HL,(<a href="31940.html">31940</a>)</td>
<td class="comment-1" rowspan="1">Pick up the bell's location in the current maze.</td>
</tr>
<tr>
<td class="address-1"><span id="27047"></span>27047</td>
<td class="instruction">LD A,H</td>
<td class="comment-1" rowspan="2">Has Horace already sounded the alarm?</td>
</tr>
<tr>
<td class="address-1"><span id="27048"></span>27048</td>
<td class="instruction">OR L</td>
</tr>
<tr>
<td class="address-1"><span id="27049"></span>27049</td>
<td class="instruction">JR NZ,<a href="27044.html#27088">27088</a></td>
<td class="comment-1" rowspan="1">Jump if not.</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="27051"></span>
<div class="comments">
<div class="paragraph">
Horace has already sounded the alarm. Produce an appropriate delay in place of the bell sound.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="27051"></span>27051</td>
<td class="instruction">LD A,(<a href="31842.html">31842</a>)</td>
<td class="comment-1" rowspan="1">Pick up the game speed parameter in <span class="register">A</span>.</td>
</tr>
<tr>
<td class="address-1"><span id="27054"></span>27054</td>
<td class="instruction">LD E,A</td>
<td class="comment-1" rowspan="6"><span class="register">HL</span>=350+30*<span class="register">A</span>.</td>
</tr>
<tr>
<td class="address-1"><span id="27055"></span>27055</td>
<td class="instruction">LD HL,350</td>
</tr>
<tr>
<td class="address-2"><span id="27058"></span>27058</td>
<td class="instruction">LD BC,30</td>
</tr>
<tr>
<td class="address-1"><span id="27061"></span>27061</td>
<td class="instruction">ADD HL,BC</td>
</tr>
<tr>
<td class="address-1"><span id="27062"></span>27062</td>
<td class="instruction">DEC E</td>
</tr>
<tr>
<td class="address-1"><span id="27063"></span>27063</td>
<td class="instruction">JR NZ,<a href="27044.html#27058">27058</a></td>
</tr>
<tr>
<td class="address-1"><span id="27065"></span>27065</td>
<td class="instruction">XOR A</td>
<td class="comment-1" rowspan="1">Clear <span class="register">A</span> for no apparent reason.</td>
</tr>
<tr>
<td class="address-1"><span id="27066"></span>27066</td>
<td class="instruction">LD A,(<a href="27402.html">27402</a>)</td>
<td class="comment-1" rowspan="1">Pick up the active guard counter (0-3) in <span class="register">A</span>.</td>
</tr>
<tr>
<td class="address-1"><span id="27069"></span>27069</td>
<td class="instruction">RLA</td>
<td class="comment-1" rowspan="10">Subtract 128*<span class="register">A</span> from <span class="register">HL</span>.</td>
</tr>
<tr>
<td class="address-1"><span id="27070"></span>27070</td>
<td class="instruction">RLA</td>
</tr>
<tr>
<td class="address-1"><span id="27071"></span>27071</td>
<td class="instruction">RLA</td>
</tr>
<tr>
<td class="address-1"><span id="27072"></span>27072</td>
<td class="instruction">RLA</td>
</tr>
<tr>
<td class="address-1"><span id="27073"></span>27073</td>
<td class="instruction">RLA</td>
</tr>
<tr>
<td class="address-1"><span id="27074"></span>27074</td>
<td class="instruction">RLA</td>
</tr>
<tr>
<td class="address-1"><span id="27075"></span>27075</td>
<td class="instruction">LD B,0</td>
</tr>
<tr>
<td class="address-1"><span id="27077"></span>27077</td>
<td class="instruction">LD C,A</td>
</tr>
<tr>
<td class="address-1"><span id="27078"></span>27078</td>
<td class="instruction">SBC HL,BC</td>
</tr>
<tr>
<td class="address-1"><span id="27080"></span>27080</td>
<td class="instruction">SBC HL,BC</td>
</tr>
<tr>
<td class="address-1"><span id="27082"></span>27082</td>
<td class="instruction">PUSH HL</td>
<td class="comment-1" rowspan="2">Copy <span class="register">HL</span> to <span class="register">BC</span>.</td>
</tr>
<tr>
<td class="address-1"><span id="27083"></span>27083</td>
<td class="instruction">POP BC</td>
</tr>
<tr>
<td class="address-1"><span id="27084"></span>27084</td>
<td class="instruction">CALL <a href="27404.html">27404</a></td>
<td class="comment-1" rowspan="1">Wait for 26*<span class="register">BC</span>+5 T states.</td>
</tr>
<tr>
<td class="address-1"><span id="27087"></span>27087</td>
<td class="instruction">RET</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="27088"></span>
<div class="comments">
<div class="paragraph">
Horace has not sounded the alarm yet. Produce an appropriate bell sound if necessary.
</div>
<div class="paragraph">
<audio controls="" src="../../audio/bell.ogg">
<p>Your browser doesn't support HTML5 audio. Here is a <a href="../../audio/bell.ogg">link to the audio</a> instead.</p>
</audio>
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="27088"></span>27088</td>
<td class="instruction">LD A,(<a href="31942.html">31942</a>)</td>
<td class="comment-1" rowspan="1">Pick up the bell animation frame counter.</td>
</tr>
<tr>
<td class="address-1"><span id="27091"></span>27091</td>
<td class="instruction">AND 63</td>
<td class="comment-1" rowspan="1">Keep only bits 0-5.</td>
</tr>
<tr>
<td class="address-1"><span id="27093"></span>27093</td>
<td class="instruction">CP 0</td>
<td class="comment-1" rowspan="1">Is the frame counter a multiple of 64 at the moment? (This instruction is redundant.)</td>
</tr>
<tr>
<td class="address-1"><span id="27095"></span>27095</td>
<td class="instruction">JR NZ,<a href="27044.html#27126">27126</a></td>
<td class="comment-1" rowspan="1">Jump if not.</td>
</tr>
<tr>
<td class="address-1"><span id="27097"></span>27097</td>
<td class="instruction">LD HL,<a href="31849.html">31849</a></td>
<td class="comment-1" rowspan="2">Pick up the sound on/off indicator in <span class="register">A</span>.</td>
</tr>
<tr>
<td class="address-1"><span id="27100"></span>27100</td>
<td class="instruction">LD A,(HL)</td>
</tr>
<tr>
<td class="address-1"><span id="27101"></span>27101</td>
<td class="instruction">CP 31</td>
<td class="comment-1" rowspan="1">Is the sound on?</td>
</tr>
<tr>
<td class="address-1"><span id="27103"></span>27103</td>
<td class="instruction">JR NZ,<a href="27044.html#27051">27051</a></td>
<td class="comment-1" rowspan="1">Jump if not.</td>
</tr>
<tr>
<td class="address-1"><span id="27105"></span>27105</td>
<td class="instruction">LD DE,22</td>
<td class="comment-1" rowspan="3">Call the ROM to make a short sound effect.</td>
</tr>
<tr>
<td class="address-1"><span id="27108"></span>27108</td>
<td class="instruction">LD HL,403</td>
</tr>
<tr>
<td class="address-1"><span id="27111"></span>27111</td>
<td class="instruction">CALL 949</td>
</tr>
<tr>
<td class="address-1"><span id="27114"></span>27114</td>
<td class="instruction">DI</td>
<td class="comment-1" rowspan="1">Disable interrupts after the ROM call.</td>
</tr>
<tr>
<td class="address-1"><span id="27115"></span>27115</td>
<td class="instruction">LD DE,26</td>
<td class="comment-1" rowspan="3">Call the ROM again to make another short sound effect.</td>
</tr>
<tr>
<td class="address-1"><span id="27118"></span>27118</td>
<td class="instruction">LD HL,360</td>
</tr>
<tr>
<td class="address-1"><span id="27121"></span>27121</td>
<td class="instruction">CALL 949</td>
</tr>
<tr>
<td class="address-1"><span id="27124"></span>27124</td>
<td class="instruction">DI</td>
<td class="comment-1" rowspan="1">Disable interrupts after the ROM call.</td>
</tr>
<tr>
<td class="address-1"><span id="27125"></span>27125</td>
<td class="instruction">RET</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="address-2"><span id="27126"></span>27126</td>
<td class="instruction">CP 32</td>
<td class="comment-1" rowspan="1">Is the bell animation frame counter a multiple of 32 at the moment?</td>
</tr>
<tr>
<td class="address-1"><span id="27128"></span>27128</td>
<td class="instruction">JR NZ,<a href="27044.html#27051">27051</a></td>
<td class="comment-1" rowspan="1">Jump if not.</td>
</tr>
<tr>
<td class="address-1"><span id="27130"></span>27130</td>
<td class="instruction">LD HL,<a href="31849.html">31849</a></td>
<td class="comment-1" rowspan="2">Pick up the sound on/off indicator in <span class="register">A</span>.</td>
</tr>
<tr>
<td class="address-1"><span id="27133"></span>27133</td>
<td class="instruction">LD A,(HL)</td>
</tr>
<tr>
<td class="address-1"><span id="27134"></span>27134</td>
<td class="instruction">CP 31</td>
<td class="comment-1" rowspan="1">Is the sound on?</td>
</tr>
<tr>
<td class="address-1"><span id="27136"></span>27136</td>
<td class="instruction">JR NZ,<a href="27044.html#27051">27051</a></td>
<td class="comment-1" rowspan="1">Jump if not.</td>
</tr>
<tr>
<td class="address-1"><span id="27138"></span>27138</td>
<td class="instruction">LD DE,26</td>
<td class="comment-1" rowspan="3">Call the ROM to make a short sound effect.</td>
</tr>
<tr>
<td class="address-1"><span id="27141"></span>27141</td>
<td class="instruction">LD HL,360</td>
</tr>
<tr>
<td class="address-1"><span id="27144"></span>27144</td>
<td class="instruction">CALL 949</td>
</tr>
<tr>
<td class="address-1"><span id="27147"></span>27147</td>
<td class="instruction">DI</td>
<td class="comment-1" rowspan="1">Disable interrupts after the ROM call.</td>
</tr>
<tr>
<td class="address-1"><span id="27148"></span>27148</td>
<td class="instruction">LD DE,22</td>
<td class="comment-1" rowspan="3">Call the ROM again to make another short sound effect.</td>
</tr>
<tr>
<td class="address-1"><span id="27151"></span>27151</td>
<td class="instruction">LD HL,403</td>
</tr>
<tr>
<td class="address-1"><span id="27154"></span>27154</td>
<td class="instruction">CALL 949</td>
</tr>
<tr>
<td class="address-1"><span id="27157"></span>27157</td>
<td class="instruction">DI</td>
<td class="comment-1" rowspan="1">Disable interrupts after the ROM call.</td>
</tr>
<tr>
<td class="address-1"><span id="27158"></span>27158</td>
<td class="instruction">RET</td>
<td class="comment-1" rowspan="1"></td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="27022.html">27022</a>
</td>
<td class="up">Up: <a href="../maps/all.html#27044">Map</a></td>
<td class="next">
Next: <a href="27159.html">27159</a>
</td>
</tr>
</table>
<footer>
<div class="release">The complete Hungry Horace RAM disassembly 20221122</div>
<div class="copyright">&#169; 1982 Beam Software. &#169; 2022 Richard Dymond.</div>
<div class="created">Created using <a href="https://skoolkit.ca">SkoolKit</a> 8.8.</div>
<div><a href="../../asm/69A4.html">Switch to hexadecimal</a>.</div>
</footer>
</body>
</html>